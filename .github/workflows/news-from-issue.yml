name: "News from Issue"

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  build-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Parse issue (title, date, lang, slug, body)
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue || {};
            const rawTitle = (issue.title || "").trim();
            const rawBody  = (issue.body  || "").trim();

            if(!rawTitle){
              core.setFailed("Missing Issue Title"); return;
            }
            if(!rawBody){
              core.setFailed("Missing Issue Body (write the article text)"); return;
            }

            // Language: from a simple line like "Language: en|sv|sr" (anywhere), else 'en'
            const langMatch = rawBody.match(/^\s*Language:\s*(en|sv|sr)\s*$/im);
            const lang = (langMatch ? langMatch[1].toLowerCase() : "en");

            // Remove the Language line from the stored body
            const bodyClean = rawBody.replace(/^\s*Language:\s*(en|sv|sr)\s*$/gim, "").trim();

            // Date: search dd-mm-yyyy in Title first, then Body; else today (runner date)
            function pad(n){ return String(n).padStart(2, "0"); }
            function findDate(s){
              const m = s.match(/\b(\d{2})-(\d{2})-(\d{4})\b/);
              if(!m) return null;
              return { dd:m[1], mm:m[2], yyyy:m[3] };
            }
            let d = findDate(rawTitle) || findDate(bodyClean);
            if(!d){
              const now = new Date();
              d = { dd: pad(now.getDate()), mm: pad(now.getMonth()+1), yyyy: String(now.getFullYear()) };
            }
            const year=d.yyyy, month=d.mm, day=d.dd;

            // Title: use Issue Title only (strip leading date and optional "News: ")
            const title = rawTitle
              .replace(/^\s*\d{2}-\d{2}-\d{4}\s*[:â€“-]\s*/,"")
              .replace(/^News:\s*/,"")
              .trim();

            // Slug: auto-generate from Title
            function slugify(s){
              return (s || "news")
                .normalize("NFKD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .replace(/&/g, " and ")
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/^-+|-+$/g, "");
            }
            const slug = slugify(title);

            // Paths
            const basePath = `i18n/news/${year}/${month}/${day}-${slug}`;
            const imgDir   = `assets/img/news/${year}/${month}/${day}-${slug}`;

            // Attached images (GitHub auto-inlines user-images URLs)
            const imgUrls = Array.from(bodyClean.matchAll(/https:\/\/user-images\.githubusercontent\.com\/[^\s)\]]+/g)).map(x=>x[0]);

            core.info(`Parsed -> date=${day}-${month}-${year}, lang=${lang}, slug=${slug}`);
            core.setOutput("year", year);
            core.setOutput("month", month);
            core.setOutput("day", day);
            core.setOutput("slug", slug);
            core.setOutput("lang", lang);
            core.setOutput("title", title);
            core.setOutput("basePath", basePath);
            core.setOutput("imgDir", imgDir);
            core.setOutput("bodyMd", bodyClean);
            core.setOutput("imgUrls", JSON.stringify(imgUrls));
            core.setOutput("branch", `feat/news-${year}-${month}-${day}-${slug}`);

      - name: Create branch
        run: git switch -c "${{ steps.parse.outputs.branch }}"

      - name: Ensure folders
        run: |
          mkdir -p "${{ steps.parse.outputs.imgDir }}"
          mkdir -p "$(dirname "${{ steps.parse.outputs.basePath }}")"

      - name: Install image tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick webp jq

      - name: Download attached images (if any)
        if: ${{ fromJSON(steps.parse.outputs.imgUrls).length > 0 }}
        run: |
          set -e
          cd "${{ steps.parse.outputs.imgDir }}"
          echo '${{ steps.parse.outputs.imgUrls }}' | jq -r '.[]' | while read -r URL; do
            NAME="$(basename "$URL" | cut -d'?' -f1)"
            curl -L "$URL" -o "$NAME"
          done

      - name: Generate 600/1200 JPG + WebP variants
        if: ${{ fromJSON(steps.parse.outputs.imgUrls).length > 0 }}
        run: |
          set -e
          cd "${{ steps.parse.outputs.imgDir }}"
          shopt -s nullglob
          for f in *; do
            [[ "$f" == *-600.* || "$f" == *-1200.* ]] && continue
            magick "$f" -auto-orient -resize 1200x1200\> "${f%.*}-1200.jpg"
            magick "$f" -auto-orient -resize 600x600\>   "${f%.*}-600.jpg"
            cwebp -q 85 "${f%.*}-1200.jpg" -o "${f%.*}-1200.webp" >/dev/null 2>&1
            cwebp -q 85 "${f%.*}-600.jpg"  -o "${f%.*}-600.webp"  >/dev/null 2>&1
          done

      - name: Write language JSON
        run: |
          TITLE='${{ steps.parse.outputs.title }}'
          BODY='${{ steps.parse.outputs.bodyMd }}'
          LANG='${{ steps.parse.outputs.lang }}'
          BASE='${{ steps.parse.outputs.basePath }}'
          mkdir -p "$(dirname "$BASE")"
          printf '{\n  "title": %s,\n  "body": %s\n}\n' \
            "$(jq -Rsa . <<<"$TITLE")" \
            "$(jq -Rsa . <<<"$BODY")" \
            > "${BASE}.${LANG}.json"

      - name: Update metadata list
        run: |
          YEAR='${{ steps.parse.outputs.year }}'
          MONTH='${{ steps.parse.outputs.month }}'
          DAY='${{ steps.parse.outputs.day }}'
          SLUG='${{ steps.parse.outputs.slug }}'
          BASE='${{ steps.parse.outputs.basePath }}'
          META_FILE="data/news/index.json"
          mkdir -p "$(dirname "$META_FILE")"
          [ -f "$META_FILE" ] || echo "[]" > "$META_FILE"
          DATE_ISO="${YEAR}-${MONTH}-${DAY}"
          NEW_OBJ=$(jq -n \
            --arg date "$DATE_ISO" \
            --arg slug "$SLUG" \
            --arg i18nPath "$BASE" \
            '{date:$date, slug:$slug, i18nPath:$i18nPath}')
          TMP=$(mktemp)
          jq --arg d "$DATE_ISO" --arg s "$SLUG" 'map(select(.date != $d or .slug != $s))' "$META_FILE" > "$TMP" && mv "$TMP" "$META_FILE"
          jq --argjson obj "$NEW_OBJ" '. += [$obj]' "$META_FILE" > "$TMP" && mv "$TMP" "$META_FILE"

      - name: Commit
        run: |
          git add -A
          git commit -m "news: add ${{ steps.parse.outputs.year }}-${{ steps.parse.outputs.month }}-${{ steps.parse.outputs.day }} ${{ steps.parse.outputs.slug }} (${{ steps.parse.outputs.lang }}) from issue #${{ github.event.issue.number }}"

      - name: Push branch
        run: git push -u origin "${{ steps.parse.outputs.branch }}"

      - name: Open PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issue.title,
              head: '${{ steps.parse.outputs.branch }}',
              base: 'main',
              body: `Automated PR for news post from issue #${context.payload.issue.number}.`
            });
            core.info(`PR opened: ${pr.html_url}`)
