name: News Processor

on:
  workflow_dispatch:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: read

env:
  TZ: Europe/Stockholm

jobs:
  build-news:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'issues'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive inputs from issue
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            RAW_TITLE="${{ github.event.issue.title }}"
            RAW_BODY="${{ github.event.issue.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            RAW_TITLE="Manual test"
            RAW_BODY="Body entered via workflow_dispatch."
            ISSUE_NUMBER="${{ github.run_id }}"
          fi

          # --- Title (no prefixes, just trimmed) ---
          TITLE_TRIMMED="$(printf '%s' "$RAW_TITLE" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          [[ -z "$TITLE_TRIMMED" ]] && { echo "ERROR: Empty title." >&2; exit 1; }

          # --- Language: must come from issue form field id: language ---
          # Contract: the form body contains a block like:
          #   <!-- language -->
          #   sv
          # or en/sr on the next non-empty line.
          BODY_LANG="$(printf '%s\n' "$RAW_BODY" | awk '
            BEGIN { mode=0 }
            {
              line = $0
              low  = tolower(line)

              if (mode == 0 && low ~ /<!--[[:space:]]*language[[:space:]]*-->/) {
                mode = 1
                next
              }

              if (mode == 1) {
                # next non-empty line after the marker is the value
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line == "") next
                ll = tolower(line)
                if (ll == "en" || ll == "sv" || ll == "sr") {
                  print ll
                  exit
                } else {
                  print "INVALID:" ll
                  exit
                }
              }
            }
          ')"

          case "$BODY_LANG" in
            en|sv|sr)
              LANG="$BODY_LANG"
              ;;
            INVALID:*)
              echo "ERROR: Invalid language value in issue form: '$BODY_LANG'." >&2
              exit 1
              ;;
            *)
              echo "ERROR: Could not detect language from issue body (no <!-- language --> marker or no en/sv/sr value after it)." >&2
              exit 1
              ;;
          esac

          # --- Body: must come from the '### Body' section ---
          # Contract: issue template defines a section:
          #   ### Body
          #   <article text...>
          # until the next ### heading or end of body.
          CLEAN_BODY="$(printf '%s\n' "$RAW_BODY" | awk '
            BEGIN { in_section=0; found_any=0 }
            {
              line = $0
              low  = tolower(line)

              if (in_section == 0 && low ~ /^###[[:space:]]*body[[:space:]]*$/) {
                in_section = 1
                next
              }

              if (in_section == 1) {
                # stop at the next heading starting with ###
                if (low ~ /^###[[:space:]]*/) {
                  exit
                }
                found_any=1
                print line
              }
            }
            END {
              if (in_section == 0) {
                # no Body heading at all; CLEAN_BODY will be empty -> we handle in shell
              }
            }
          ')"

          # Trim leading/trailing empty lines in CLEAN_BODY
          CLEAN_BODY="$(printf '%s\n' "$CLEAN_BODY" | sed -E ':a;/^[[:space:]]*$/{$d;N;ba;}' | sed -E '1{/^[[:space:]]*$/d;}')"

          if [[ -z "$CLEAN_BODY" ]]; then
            echo "ERROR: Could not extract news body from issue (no '### Body' section or it is empty)." >&2
            exit 1
          fi

          # --- Date: use server date in Europe/Stockholm ---
          DATE="$(TZ="${TZ:-Europe/Stockholm}" date +%F)"
          YEAR="${DATE%%-*}"
          MONTH="$(printf '%s' "$DATE" | cut -d- -f2)"

          # --- Slug: derived mechanically from title, ASCII only ---
          SLUG="$(printf '%s' "$TITLE_TRIMMED" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[åä]/a/g;s/ö/o/g;s/č/c/g;s/ć/c/g;s/š/s/g;s/ž/z/g' \
            | sed -E 's/[^a-z0-9]+/-/g;s/-+/-/g;s/^-|-$//g')"
          [[ -z "$SLUG" ]] && SLUG="post"

          FILE_DIR="i18n/news/$YEAR/$MONTH"
          FILE_PATH="$FILE_DIR/$DATE-$SLUG.$LANG.json"

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            BRANCH="news/$DATE-$SLUG-$LANG-issue-$ISSUE_NUMBER"
          else
            BRANCH="news/$DATE-$SLUG-$LANG-run-$GITHUB_RUN_ID"
          fi

          {
            echo "TITLE<<EOF"; echo "$TITLE_TRIMMED"; echo "EOF"
            echo "BODY<<EOF"; echo "$CLEAN_BODY"; echo "EOF"
            echo "LANG=$LANG"
            echo "DATE=$DATE"
            echo "SLUG=$SLUG"
            echo "FILE_DIR=$FILE_DIR"
            echo "FILE_PATH=$FILE_PATH"
            echo "BRANCH=$BRANCH"
            echo "ISSUE_NUMBER=$ISSUE_NUMBER"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Write news JSON
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ steps.vars.outputs.FILE_DIR }}"
          jq -n \
            --arg title "${{ steps.vars.outputs.TITLE }}" \
            --arg body  "${{ steps.vars.outputs.BODY }}" \
            --arg date  "${{ steps.vars.outputs.DATE }}" \
            --arg lang  "${{ steps.vars.outputs.LANG }}" \
            --arg slug  "${{ steps.vars.outputs.SLUG }}" \
            --arg i18nPath "${{ steps.vars.outputs.FILE_PATH }}" \
            '{title:$title, body:$body, date:$date, lang:$lang, slug:$slug, i18nPath:$i18nPath}' \
            > "${{ steps.vars.outputs.FILE_PATH }}"

      - name: Commit branch
        shell: bash
        run: |
          set -euo pipefail
          git checkout -b "${{ steps.vars.outputs.BRANCH }}" || git switch "${{ steps.vars.outputs.BRANCH }}"
          git add "${{ steps.vars.outputs.FILE_PATH }}"
          git commit -m "news(${{ steps.vars.outputs.LANG }}): ${{ steps.vars.outputs.DATE }} ${{ steps.vars.outputs.SLUG }}" -m "${{ steps.vars.outputs.TITLE }}"

      - name: Push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git push -u origin "${{ steps.vars.outputs.BRANCH }}"

      - name: Open PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_TITLE="[news:${{ steps.vars.outputs.LANG }}] ${{ steps.vars.outputs.DATE }} ${{ steps.vars.outputs.TITLE }}"
          PR_BODY="Auto-generated from issue #${{ steps.vars.outputs.ISSUE_NUMBER }}.\n\n- lang: \`${{ steps.vars.outputs.LANG }}\`\n- date: \`${{ steps.vars.outputs.DATE }}\`\n- slug: \`${{ steps.vars.outputs.SLUG }}\`\n- file: \`${{ steps.vars.outputs.FILE_PATH }}\`"
          gh pr create --base main --head "${{ steps.vars.outputs.BRANCH }}" --title "$PR_TITLE" --body "$PR_BODY"
