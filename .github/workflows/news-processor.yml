name: News Processor

on:
  workflow_dispatch:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: read

env:
  TZ: Europe/Stockholm

jobs:
  build-news:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'issues'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive inputs
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            RAW_TITLE="${{ github.event.issue.title }}"
            RAW_BODY="${{ github.event.issue.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            RAW_TITLE="EN: Manual test"
            RAW_BODY="Body entered via workflow_dispatch."
            ISSUE_NUMBER="${{ github.run_id }}"
          fi

          TITLE_TRIMMED="$(printf '%s' "$RAW_TITLE" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          LANG="en"
          TITLE_NO_PREFIX="$TITLE_TRIMMED"
          if [[ "$TITLE_TRIMMED" =~ ^SV:[[:space:]]*(.*)$ ]]; then
            LANG="sv"; TITLE_NO_PREFIX="${BASH_REMATCH[1]}"
          elif [[ "$TITLE_TRIMMED" =~ ^SR:[[:space:]]*(.*)$ ]]; then
            LANG="sr"; TITLE_NO_PREFIX="${BASH_REMATCH[1]}"
          fi

          # Try to read language from issue body "### Language" section (en/sv/sr)
          BODY_LANG="$(printf '%s\n' "$RAW_BODY" | awk '
            BEGIN { seen=0 }
            tolower($0) ~ /^###[[:space:]]*language[[:space:]]*$/ { seen=1; next }
            seen==1 {
              gsub(/^[[:space:]]+|[[:space:]]+$/,"",$0);
              print tolower($0);
              exit
            }
          ')"
          if [[ "$BODY_LANG" == "en" || "$BODY_LANG" == "sv" || "$BODY_LANG" == "sr" ]]; then
            LANG="$BODY_LANG"
          fi

          TITLE_NO_PREFIX="$(printf '%s' "$TITLE_NO_PREFIX" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          [[ -z "$TITLE_NO_PREFIX" ]] && { echo "Empty title after prefix strip" >&2; exit 1; }

          DATE="$(TZ="${TZ:-Europe/Stockholm}" date +%F)"
          YEAR="${DATE%%-*}"
          MONTH="$(printf '%s' "$DATE" | cut -d- -f2)"

          SLUG="$(printf '%s' "$TITLE_NO_PREFIX" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[åä]/a/g;s/ö/o/g;s/č/c/g;s/ć/c/g;s/š/s/g;s/ž/z/g' \
            | sed -E 's/[^a-z0-9]+/-/g;s/-+/-/g;s/^-|-$//g')"
          [[ -z "$SLUG" ]] && SLUG="post"

          FILE_DIR="i18n/news/$YEAR/$MONTH"
          FILE_PATH="$FILE_DIR/$DATE-$SLUG.$LANG.json"

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            BRANCH="news/$DATE-$SLUG-$LANG-issue-$ISSUE_NUMBER"
          else
            BRANCH="news/$DATE-$SLUG-$LANG-run-$GITHUB_RUN_ID"
          fi

          {
            echo "TITLE<<EOF"; echo "$TITLE_NO_PREFIX"; echo "EOF"
            echo "BODY<<EOF"; echo "$RAW_BODY"; echo "EOF"
            echo "LANG=$LANG"
            echo "DATE=$DATE"
            echo "SLUG=$SLUG"
            echo "FILE_DIR=$FILE_DIR"
            echo "FILE_PATH=$FILE_PATH"
            echo "BRANCH=$BRANCH"
            echo "ISSUE_NUMBER=$ISSUE_NUMBER"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Write news JSON
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ steps.vars.outputs.FILE_DIR }}"
          jq -n \
            --arg title "${{ steps.vars.outputs.TITLE }}" \
            --arg body  "${{ steps.vars.outputs.BODY }}" \
            --arg date  "${{ steps.vars.outputs.DATE }}" \
            --arg lang  "${{ steps.vars.outputs.LANG }}" \
            --arg slug  "${{ steps.vars.outputs.SLUG }}" \
            --arg i18nPath "${{ steps.vars.outputs.FILE_PATH }}" \
            '{title:$title, body:$body, date:$date, lang:$lang, slug:$slug, i18nPath:$i18nPath}' \
            > "${{ steps.vars.outputs.FILE_PATH }}"

      - name: Commit branch
        shell: bash
        run: |
          set -euo pipefail
          git checkout -b "${{ steps.vars.outputs.BRANCH }}" || git switch "${{ steps.vars.outputs.BRANCH }}"
          git add "${{ steps.vars.outputs.FILE_PATH }}"
          git commit -m "news(${{ steps.vars.outputs.LANG }}): ${{ steps.vars.outputs.DATE }} ${{ steps.vars.outputs.SLUG }}" -m "${{ steps.vars.outputs.TITLE }}"

      - name: Push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git push -u origin "${{ steps.vars.outputs.BRANCH }}"

      - name: Open PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_TITLE="[news:${{ steps.vars.outputs.LANG }}] ${{ steps.vars.outputs.DATE }} ${{ steps.vars.outputs.TITLE }}"
          PR_BODY="Auto-generated from issue #${{ steps.vars.outputs.ISSUE_NUMBER }}.\n\n- lang: \`${{ steps.vars.outputs.LANG }}\`\n- date: \`${{ steps.vars.outputs.DATE }}\`\n- slug: \`${{ steps.vars.outputs.SLUG }}\`\n- file: \`${{ steps.vars.outputs.FILE_PATH }}\`"
          gh pr create --base main --head "${{ steps.vars.outputs.BRANCH }}" --title "$PR_TITLE" --body "$PR_BODY"
