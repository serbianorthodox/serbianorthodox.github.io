name: News from Issue (revived)

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  build-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Derive language, clean title, slug
        id: meta
        env:
          RAW_TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          T="$RAW_TITLE"

          if echo "$T" | grep -Eiq '^[[:space:]]*SV:[[:space:]]*'; then
            LANG_CODE=sv
            CLEAN_TITLE="$(printf '%s' "$T" | sed -E 's/^[[:space:]]*SV:[[:space:]]*//I')"
          elif echo "$T" | grep -Eiq '^[[:space:]]*SR:[[:space:]]*'; then
            LANG_CODE=sr
            CLEAN_TITLE="$(printf '%s' "$T" | sed -E 's/^[[:space:]]*SR:[[:space:]]*//I')"
          else
            LANG_CODE=en
            CLEAN_TITLE="$T"
          fi

          SLUG_SRC="$CLEAN_TITLE"
          SLUG="$(printf '%s' "$SLUG_SRC" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || printf '%s' "$SLUG_SRC")"
          SLUG="$(printf '%s' "$SLUG" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/-+/-/g; s/^-|-$//g')"
          if [ -z "$SLUG" ]; then SLUG="post"; fi

          YEAR="$(date -u +%Y)"
          MONTH="$(date -u +%m)"
          DAY="$(date -u +%d)"
          ISO_DATE="$(date -u +%Y-%m-%d)"

          BODY_RAW='${{ github.event.issue.body }}'
          BODY_JSON="$(printf '%s' "$BODY_RAW" | jq -Rs .)"
          TITLE_JSON="$(printf '%s' "$CLEAN_TITLE" | jq -Rs .)"

          BASE_DIR="i18n/news/${YEAR}/${MONTH}"
          FILE_BASENAME="${DAY}-${SLUG}"
          LANG_FILE="${BASE_DIR}/${FILE_BASENAME}.${LANG_CODE}.json"

          {
            echo "lang=$LANG_CODE"
            echo "title=$CLEAN_TITLE"
            echo "slug=$SLUG"
            echo "year=$YEAR"
            echo "month=$MONTH"
            echo "day=$DAY"
            echo "isodate=$ISO_DATE"
            echo "base_dir=$BASE_DIR"
            echo "file_basename=$FILE_BASENAME"
            echo "lang_file=$LANG_FILE"
            echo "body_json=$BODY_JSON"
            echo "title_json=$TITLE_JSON"
          } >> "$GITHUB_OUTPUT"

      - name: Write ONLY the language JSON
        env:
          LANG_FILE: ${{ steps.meta.outputs.lang_file }}
          BASE_DIR: ${{ steps.meta.outputs.base_dir }}
          TITLE_JSON: ${{ steps.meta.outputs.title_json }}
          BODY_JSON: ${{ steps.meta.outputs.body_json }}
          ISO_DATE: ${{ steps.meta.outputs.isodate }}
        run: |
          set -euo pipefail
          mkdir -p "$BASE_DIR"
          jq -n \
            --argjson title "$TITLE_JSON" \
            --argjson body "$BODY_JSON" \
            --arg date "$ISO_DATE" \
            '{ "title": $title, "date": $date, "body": $body } | .title |= fromjson | .body |= fromjson' \
            > "$LANG_FILE"
          echo "Wrote $LANG_FILE"

      - name: Ensure index.json updated (newest-first)
        env:
          YEAR: ${{ steps.meta.outputs.year }}
          MONTH: ${{ steps.meta.outputs.month }}
          DAY: ${{ steps.meta.outputs.day }}
          SLUG: ${{ steps.meta.outputs.slug }}
        run: |
          set -euo pipefail
          INDEX="data/news/index.json"
          mkdir -p "data/news"
          [ -s "$INDEX" ] || echo "[]" > "$INDEX"
          NEW_ENTRY=$(jq -n \
            --arg y "$YEAR" --arg m "$MONTH" --arg d "$DAY" --arg s "$SLUG" \
            '{year: ($y|tonumber), month: ($m|tonumber), day: ($d|tonumber), slug: $s}')
          TMP="$(mktemp)"
          jq --argjson e "$NEW_ENTRY" '
            map(select(.year != $e.year or .month != $e.month or .day != $e.day or .slug != $e.slug))
          ' "$INDEX" > "$TMP" && mv "$TMP" "$INDEX"
          jq --argjson e "$NEW_ENTRY" '[ $e ] + .' "$INDEX" > "$TMP" && mv "$TMP" "$INDEX"
          echo "Updated $INDEX"

      - name: Create branch, commit, push
        id: git
        env:
          YEAR: ${{ steps.meta.outputs.year }}
          MONTH: ${{ steps.meta.outputs.month }}
          DAY: ${{ steps.meta.outputs.day }}
          SLUG: ${{ steps.meta.outputs.slug }}
          LANG: ${{ steps.meta.outputs.lang }}
        run: |
          set -euo pipefail
          BR="news/${YEAR}-${MONTH}-${DAY}-${SLUG}-${LANG}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BR"
          git add -A
          git commit -m "news: ${YEAR}-${MONTH}-${DAY} ${SLUG} [${LANG}]"
          git push -u origin "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      - name: Open PR
        env:
          BRANCH: ${{ steps.git.outputs.branch }}
        run: |
          set -euo pipefail
          PR_TITLE="News: ${BRANCH}"
          gh pr create --head "$BRANCH" --base "main" --title "$PR_TITLE" --body "Automated news update from issue."
